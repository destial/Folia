From 92ebed132f15ec6f7e8fc7764e7df2990770aa90 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Sun, 23 Apr 2023 07:08:26 -0700
Subject: [PATCH 5/8] Block reading in-world tile entities on worldgen threads

The returned TE may be in the world, in which case it is unsafe
for the current thread to modify or access its contents.
---
 net/minecraft/world/level/chunk/ImposterProtoChunk.java | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/net/minecraft/world/level/chunk/ImposterProtoChunk.java b/net/minecraft/world/level/chunk/ImposterProtoChunk.java
index d1331b5..b430bb3 100644
--- a/net/minecraft/world/level/chunk/ImposterProtoChunk.java
+++ b/net/minecraft/world/level/chunk/ImposterProtoChunk.java
@@ -91,6 +91,11 @@ public class ImposterProtoChunk extends ProtoChunk implements ca.spottedleaf.moo
     @Nullable
     @Override
     public BlockEntity getBlockEntity(BlockPos pos) {
+        // Folia start - block reading possibly in-world block data for worldgen threads
+        if (!this.allowWrites && !ca.spottedleaf.moonrise.common.util.TickThread.isTickThread()) {
+            return null;
+        }
+        // Folia end - block reading possibly in-world block data for worldgen threads
         return this.wrapped.getBlockEntity(pos);
     }
 
-- 
2.52.0.windows.1

